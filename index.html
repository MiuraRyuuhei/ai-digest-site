<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIニュースダイジェスト</title>
  <style>
    /* 基本スタイル */
    :root { --bg:#0b1020; --card:#111831; --ink:#e6ecff; --muted:#9fb0ff; --accent:#6ea8fe; --chip:#1a2345; --ok:#3ddc97; }
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b1020 80%,#0b1020cc 100%);backdrop-filter: blur(8px);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 420px}
    input[type="search"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #243059;background:var(--card);color:var(--ink)}
    .btn{border:1px solid #243059;background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#2f3c6f}
    .muted{color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;background:#103a2b;color:#b9f5dd;border:1px solid #1f6b4f;font-size:12px}
    /* 2カラム */
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){ .cols{grid-template-columns:1fr} }
    /* カード */
    .cards{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:700;font-size:16px;line-height:1.4}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .chip{background:var(--chip);padding:3px 8px;border-radius:999px;border:1px solid #2a3665}
    .summary{color:#dbe5ff}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1 style="margin:0;font-size:20px;">AIニュースピックアップ</h1>
        <span id="lastUpdated" class="muted" style="margin-left:auto;"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="searchInput" class="grow" type="search" placeholder="キーワード または  site:huggingface.co のように検索…" />
        <button id="searchBtn" class="btn">検索</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="cols" style="margin-top:12px;">
      <!-- 左：検索結果 -->
      <section>
        <h2 style="font-size:16px;margin:0 0 8px;">検索結果 <span id="searchCount" class="muted"></span></h2>
        <div id="searchResults" class="cards" aria-live="polite"></div>
      </section>
      <!-- 右：おすすめ -->
      <section>
        <h2 style="font-size:16px;margin:0 0 8px;">あなたへのおすすめ</h2>
        <div id="recoResults" class="cards" aria-live="polite"></div>
      </section>
    </div>
  </main>

  <script>
    let ITEMS = [];  // すべての記事
    let LAST_QUERY = "";  // 最後の検索クエリ

    const stopwords = new Set("a,an,the,of,to,in,on,for,with,and,or,is,are,was,were,be,as,at,by,from,this,that,these,those,about,into,over,under,than,then,it,its,our,your,his,her,their,not".split(","));

    // 小ユーティリティ
    const $ = s => document.querySelector(s);
    const host = url => { try { return new URL(url).host.replace(/^www\./,''); } catch { return ""; } };
    const esc = s => (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]) );

    // データ読み込み（最新のai_digest_latest.jsonをロード）
    async function loadLatest() {
      const res = await fetch('./ai_digest_latest.json', { cache: 'no-store' });
      const json = await res.json();
      ITEMS = (json.items || []).map((it, i) => ({ ...it, _id: i, _host: host(it.url) }));
      $('#lastUpdated').textContent = `最新: ${json.generated_at} / ${ITEMS.length}件`;
      renderRecommendations();  // 初期表示でおすすめを表示
    }

    // 検索：クエリをトークン化してスコアをつけてフィルタ
    function tokenize(s){
      return (s||"").toLowerCase().replace(/https?:\/\/\S+/g," ")
        .replace(/[^a-z0-9ぁ-んァ-ン一-龥ー\- ]/g," ")
        .split(/\s+/).filter(w=>w && !stopwords.has(w));
    }

    function parseQuery(q){
      const m = q.match(/(?:^|\s)site:([^\s]+)/);
      const site = m ? m[1].replace(/^https?:\/\//,'').replace(/^www\./,'') : "";
      const cleaned = q.replace(/(?:^|\s)site:[^\s]+/,' ').trim();
      return { site, tokens: tokenize(cleaned) };
    }

    function scoreItem(it, tokens, site){
      let score = 0;
      const title = tokenize(it.title);
      const summary = tokenize(it.summary);
      for(const t of tokens){
        score += title.filter(w=>w===t).length * 3;
        score += summary.filter(w=>w===t).length * 1;
      }
      if(site && it._host.includes(site)) score += 5;
      return score;
    }

    function runSearch(q){
      LAST_QUERY = q.trim();
      const { site, tokens } = parseQuery(LAST_QUERY);
      let scored = ITEMS.map(it => ({ it, s: scoreItem(it, tokens, site) }));
      if(site) scored = scored.filter(x => x.it._host.includes(site));
      scored = scored.filter(x => x.s > 0).sort((a,b)=>b.s-a.s).map(x=>x.it).slice(0,3); // 検索結果
      $('#searchCount').textContent = scored.length ? `${scored.length}件` : '0件';
      renderList(scored, $('#searchResults'));
      renderRecommendations(scored);  // 検索に応じておすすめも更新
    }

    // レコメンド（検索履歴に基づいて表示）
    function recommendByQuery(excludeIds=[]){
      if(!LAST_QUERY) return [];
      const { site, tokens } = parseQuery(LAST_QUERY);
      let scored = ITEMS.filter(it => !excludeIds.includes(it._id))
                        .map(it => ({ it, s: scoreItem(it, tokens, site) }));
      scored = scored.filter(x=>x.s>0).sort((a,b)=>b.s-a.s).map(x=>x.it);
      return uniqByHost(scored).slice(0,3);
    }

    function recommendDefault(excludeIds=[]){
      const pool = ITEMS.filter(it => !excludeIds.includes(it._id));
      const sorted = pool.slice().sort((a,b)=> String(b.published||"") > String(a.published||"") ? 1 : -1);
      return uniqByHost(sorted).slice(0,3);
    }

    function uniqByHost(list){
      const seen = new Set(); const out=[];
      for(const it of list){ if(!seen.has(it._host)){ seen.add(it._host); out.push(it); } }
      return out;
    }

    function renderRecommendations(searchPicked=[]){
      const exclude = searchPicked.map(it=>it._id);
      let recs = recommendByQuery(exclude);
      if(recs.length===0) recs = recommendDefault(exclude);
      renderList(recs, $('#recoResults'));
    }

    // 描画
    function renderList(items, root){
      root.innerHTML = items.map(it => `
        <article class="card">
          <div class="meta">
            <span class="chip">${esc(it._host)}</span>
            <span>${esc(it.published || "")}</span>
          </div>
          <div class="title">${esc(it.title || "(無題)")}</div>
          <div class="summary">${esc(it.summary || "")}</div>
          <div class="actions">
            <a class="btn" href="${it.url}" target="_blank" rel="noopener">原文を開く</a>
            <button class="btn" data-copy="${esc((it.summary || "").replace(/"/g, '&quot;'))}">要約をコピー</button>
          </div>
        </article>
      `).join("");
    }

    // イベント処理
    $('#searchBtn').addEventListener('click', () => runSearch($('#searchInput').value));
    $('#searchInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') runSearch(e.target.value); });

    // 初期ロード
    loadLatest();
  </script>

  <!-- ====== Dify チャットボット（右下固定のバブル） ====== -->
  <script>
    window.difyChatbotConfig = { token: 'G4x8fpppi7CUJMgV' };
  </script>
  <script src="https://udify.app/embed.min.js" id="G4x8fpppi7CUJMgV" defer></script>
  <style>
    #dify-chatbot-bubble-button { background-color:#1C64F2 !important; position:fixed !important; right:24px !important; bottom:24px !important; z-index:2147483647 !important; }
    #dify-chatbot-bubble-window { width:24rem !important; height:40rem !important; position:fixed !important; right:24px !important; bottom:92px !important; z-index:2147483647 !important; }
  </style>
</body>
</html>
