<script>
  let ITEMS = [];          // JSONの全件（=10件想定）
  let LAST_QUERY = "";     // 最後に使った検索クエリ

  // ---- utils ----
  const $ = s => document.querySelector(s);
  const host = url => { try { return new URL(url).host.replace(/^www\./,''); } catch { return ""; } };
  const esc  = s => (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const stopwords = new Set("a,an,the,of,to,in,on,for,with,and,or,is,are,was,were,be,as,at,by,from,this,that,these,those,about,into,over,under,than,then,it,its,our,your,his,her,their,not".split(","));

  // ① 自動で最新JSONを読み込み、左に10件を初期表示
  async function loadLatest() {
    const res = await fetch('./ai_digest_latest.json', { cache: 'no-store' });
    const json = await res.json();
    ITEMS = (json.items || []).map((it, i) => ({ ...it, _id: i, _host: host(it.url) }));
    $('#lastUpdated').textContent = `最新: ${json.generated_at} / ${ITEMS.length}件`;

    // 初期：左=10件すべて、右=レコメンド
    renderList(ITEMS.slice(0, 10), $('#searchResults'));
    $('#searchCount').textContent = `${Math.min(10, ITEMS.length)}件`;
    renderRecommendations();
  }

  // ② 検索（site: ドメインフィルタ対応）— 10件の集合から「該当のみ」に絞る
  function tokenize(s){
    return (s||"").toLowerCase().replace(/https?:\/\/\S+/g," ")
      .replace(/[^a-z0-9ぁ-んァ-ン一-龥ー\- ]/g," ")
      .split(/\s+/).filter(w=>w && !stopwords.has(w));
  }
  function parseQuery(q){
    const m = q.match(/(?:^|\s)site:([^\s]+)/);
    const site = m ? m[1].replace(/^https?:\/\//,'').replace(/^www\./,'') : "";
    const cleaned = q.replace(/(?:^|\s)site:[^\s]+/,' ').trim();
    return { site, tokens: tokenize(cleaned) };
  }
  function scoreItem(it, tokens, site){
    if(!tokens.length && !site) return 1; // 空検索は全件表示
    let score = 0;
    const title = tokenize(it.title), summary = tokenize(it.summary);
    for(const t of tokens){
      score += title.filter(w=>w===t).length * 3;
      score += summary.filter(w=>w===t).length * 1;
    }
    if(site && it._host.includes(site)) score += 5;
    return score;
  }

  function runSearch(q){
    LAST_QUERY = q.trim();
    const { site, tokens } = parseQuery(LAST_QUERY);

    // ベースは（JSONの）10件。そこから該当のみを残す。
    let filtered = ITEMS.slice(0, 10)
      .map(it => ({ it, s: scoreItem(it, tokens, site) }))
      .filter(x => x.s > 0)
      .sort((a,b)=> b.s - a.s)
      .map(x => x.it);

    // site: 指定がある場合はさらにホストでフィルタ（scoreで加点もしているが安全のため）
    if(site) filtered = filtered.filter(it => it._host.includes(site));

    // 左に表示（件数は該当数）
    renderList(filtered, $('#searchResults'));
    $('#searchCount').textContent = `${filtered.length}件`;

    // 右は常に表示。検索クエリがあればそれを反映、無ければデフォルト
    renderRecommendations(filtered);
  }

  // ③ レコメンド（右）：検索履歴を優先、無ければ新着＋ドメイン多様性
  function uniqByHost(list){
    const seen = new Set(); const out=[];
    for(const it of list){ if(!seen.has(it._host)){ seen.add(it._host); out.push(it); } }
    return out;
  }
  function recommendByQuery(excludeIds=[]){
    if(!LAST_QUERY) return [];
    const { site, tokens } = parseQuery(LAST_QUERY);
    let scored = ITEMS
      .filter(it => !excludeIds.includes(it._id))
      .map(it => ({ it, s: scoreItem(it, tokens, site) }));
    scored = scored.filter(x=>x.s>0).sort((a,b)=>b.s-a.s).map(x=>x.it);
    return uniqByHost(scored).slice(0,3);
  }
  function recommendDefault(excludeIds=[]){
    const pool = ITEMS.filter(it => !excludeIds.includes(it._id));
    const sorted = pool.slice().sort((a,b)=> String(b.published||"") > String(a.published||"") ? 1 : -1);
    return uniqByHost(sorted).slice(0,3);
  }
  function renderRecommendations(searchPicked=[]){
    const exclude = (searchPicked||[]).map(it=>it._id);
    let recs = recommendByQuery(exclude);
    if(recs.length===0) recs = recommendDefault(exclude);
    renderList(recs, $('#recoResults'));
  }

  // 共通カード描画
  function cardHTML(it){
    return `
      <article class="card">
        <div class="meta">
          <span class="chip">${esc(it._host || "source")}</span>
          <span>${esc(it.published || "")}</span>
        </div>
        <div class="title">${esc(it.title || "(無題)")}</div>
        <div class="summary">${esc(it.summary || "")}</div>
        <div class="actions">
          <a class="btn" href="${it.url}" target="_blank" rel="noopener">原文を開く</a>
          <button class="btn" data-copy="${esc((it.summary||"").replace(/"/g,'&quot;'))}">要約をコピー</button>
        </div>
      </article>`;
  }
  function renderList(items, root){
    root.innerHTML = items.length
      ? items.map(cardHTML).join("")
      : `<div class="muted">該当なし</div>`;
    root.querySelectorAll('button[data-copy]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        navigator.clipboard.writeText(e.currentTarget.dataset.copy||"");
        btn.textContent = "コピーしました ✓";
        setTimeout(()=> btn.textContent = "要約をコピー", 1200);
      });
    });
  }

  // イベント
  $('#searchBtn').addEventListener('click', ()=> runSearch($('#searchInput').value));
  $('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(e.target.value); });

  // 起動
  loadLatest();
</script>
