<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIニュースピックアップ</title>
  <style>
    :root { --bg:#0b1020; --card:#111831; --ink:#e6ecff; --muted:#9fb0ff; --accent:#6ea8fe; --chip:#1a2345; --ok:#3ddc97; --border:#22305f; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b1020 80%,#0b1020cc 100%);backdrop-filter: blur(8px);z-index:10}
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 420px}
    input[type="search"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #243059;background:var(--card);color:var(--ink)}
    .btn{border:1px solid #243059;background:var(--card);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#2f3c6f}
    .muted{color:var(--muted)}
    .pill{padding:4px 8px;border-radius:999px;background:#103a2b;color:#b9f5dd;border:1px solid #1f6b4f;font-size:12px}

    .cols{display:grid;grid-template-columns:1.2fr 0.8fr;gap:16px}
    @media (max-width:980px){ .cols{grid-template-columns:1fr} }

    .cards{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:700;font-size:16px;line-height:1.4}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .chip{background:var(--chip);padding:3px 8px;border-radius:999px;border:1px solid #2a3665}
    .summary{color:#dbe5ff}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    .error{color:#ff9b9b;background:#351a1a;border:1px solid #642323;padding:8px 12px;border-radius:10px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#243059,transparent);margin:8px 0}
    .favbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* 折りたたみのスタイル */
    details { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:8px 12px; }
    details > summary { cursor:pointer; font-weight:600; outline:none; }
    details .fav-actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1 style="margin:0;font-size:20px;">AIニュースピックアップ</h1>
        <span id="lastUpdated" class="muted" style="margin-left:auto;"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="searchInput" class="grow" type="search" placeholder="キーワード または  site:huggingface.co  のように検索…" />
        <button id="searchBtn" class="btn">検索</button>
        <button id="addPrefBtn" class="btn" title="外部URLを嗜好に追加">＋ 外部リンク</button>
        <button id="clearFavBtn" class="btn" title="お気に入りをクリア">♡ クリア</button>
      </div>
      <div id="favInfo" class="favbar muted" style="margin-top:6px"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="cols" style="margin-top:12px;">
      <section>
        <h2 style="font-size:16px;margin:0 0 8px;">最新10件 <span id="searchCount" class="muted"></span></h2>
        <div id="searchResults" class="cards" aria-live="polite"></div>
        <div id="errorBox" class="error" style="display:none"></div>
      </section>

      <section>
        <h2 style="font-size:16px;margin:0 0 8px;">あなたへのおすすめ（過去傾向ベース）</h2>
        <div id="recoResults" class="cards" aria-live="polite"></div>

        <section style="margin-top:16px;">
          <h2 style="font-size:16px;margin:0 0 8px;">お気に入り（クリックでURL展開）</h2>
          <div id="favList" class="cards" aria-live="polite"></div>
        </section>
      </section>
    </div>
  </main>

  <script>
  (function () {
    // ===== 状態 =====
    let LATEST = [];     // 最新10件
    let CORPUS = [];     // 履歴コーパス全体
    let LAST_QUERY = ""; // 検索クエリ

    // ===== util =====
    const $ = s => document.querySelector(s);
    const esc= s => (s||"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const host = url => { try { return new URL(url).host.replace(/^www\./,''); } catch { return ""; } };
    const stopwords = new Set("a,an,the,of,to,in,on,for,with,and,or,is,are,was,were,be,as,at,by,from,this,that,these,those,about,into,over,under,than,then,it,its,our,your,his,her,their,not".split(","));

    // ===== 参照 =====
    let elLast, elSearchResults, elSearchCount, elRecoResults, elSearchInput, elSearchBtn, elError, elFavInfo, elAddPrefBtn, elClearFavBtn, elFavList;
    function initRefs(){
      elLast          = $('#lastUpdated');
      elSearchResults = $('#searchResults');
      elSearchCount   = $('#searchCount');
      elRecoResults   = $('#recoResults');
      elSearchInput   = $('#searchInput');
      elSearchBtn     = $('#searchBtn');
      elError         = $('#errorBox');
      elFavInfo       = $('#favInfo');
      elAddPrefBtn    = $('#addPrefBtn');
      elClearFavBtn   = $('#clearFavBtn');
      elFavList       = $('#favList');
    }
    function showError(msg){ if (elError) { elError.style.display='block'; elError.textContent=msg; } console.error(msg); }

    // ===== localStorage: お気に入り =====
    const FAV_KEY = "ai_digest_favs";
    function loadFavs(){ try{ return JSON.parse(localStorage.getItem(FAV_KEY)||"[]"); }catch{ return []; } }
    function saveFavs(list){ localStorage.setItem(FAV_KEY, JSON.stringify(list)); renderFavInfo(); }
    function addFavorite(item){
      const favs = loadFavs();
      if (!favs.find(x => x.url === item.url)) {
        favs.push({ url:item.url, title:item.title, host:item.source||host(item.url), emb:item.emb||null });
        saveFavs(favs);
      }
    }
    function removeFavorite(url){
      const favs = loadFavs().filter(f=>f.url!==url);
      saveFavs(favs);
    }
    function clearFavorites(){ saveFavs([]); renderRecommendations(); renderFavorites(); }
    function renderFavInfo(){
      const favs = loadFavs();
      elFavInfo.innerHTML = favs.length ? `お気に入り: ${favs.length} 件 <span class="hr" style="flex:1"></span>` : "";
    }

    // ===== ベクトル演算 =====
    function meanVector(vecs){ if(!vecs.length) return null; const d=vecs[0].length; const out=new Array(d).fill(0);
      for(const v of vecs){ for(let i=0;i<d;i++) out[i]+=v[i]; }
      for(let i=0;i<d;i++) out[i]/=vecs.length; return out; }
    function cosineSim(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; } // 正規化済み想定

    // ===== データ読み込み =====
    async function loadAll(){
      try{
        const [latestRes, corpusRes] = await Promise.all([
          fetch('./ai_digest_latest.json', { cache:'no-store' }),
          fetch('./ai_digest_corpus.json', { cache:'no-store' }),
        ]);
        if(!latestRes.ok) throw new Error(`latest ${latestRes.status}`);
        if(!corpusRes.ok) throw new Error(`corpus ${corpusRes.status}`);
        const latestJson = await latestRes.json();
        const corpusJson = await corpusRes.json();

        LATEST = (latestJson.items||[]).map((it,i)=> ({...it, _id:i, source: it.source || host(it.url)}));
        CORPUS = (corpusJson.items||[]).map((it,i)=> ({...it, _cid:i, source: it.source || host(it.url)}));

        if (elLast) elLast.textContent = `最新: ${latestJson.generated_at || ''} / 最新10件: ${LATEST.length} / 履歴: ${CORPUS.length}`;
        renderList(LATEST, elSearchResults, true);
        if (elSearchCount) elSearchCount.textContent = `${LATEST.length}件`;
        renderFavInfo();
        renderRecommendations();  // ← 過去傾向ベース（コーパスから）
        renderFavorites();        // ← お気に入り一覧
      }catch(e){
        showError(`データ読み込みに失敗しました。ai_digest_latest.json / ai_digest_corpus.json の配置を確認してください。詳細: ${e.message}`);
      }
    }

    // ===== 検索（最新10件の中で） =====
    function tokenize(s){
      return (s||"").toLowerCase().replace(/https?:\/\/\S+/g," ")
        .replace(/[^a-z0-9ぁ-んァ-ン一-龥ー\- ]/g," ")
        .split(/\s+/).filter(Boolean).filter(w=>!stopwords.has(w));
    }
    function parseQuery(q){
      const m = q.match(/(?:^|\s)site:([^\s]+)/);
      const site = m ? m[1].replace(/^https?:\/\//,'').replace(/^www\./,'') : "";
      const cleaned = q.replace(/(?:^|\s)site:[^\s]+/,' ').trim();
      return { site, tokens: tokenize(cleaned) };
    }
    function scoreItem(it, tokens, site){
      if(!tokens.length && !site) return 1;
      let s=0; const tt=tokenize(it.title), ss=tokenize(it.summary);
      for(const t of tokens){ s += tt.filter(w=>w===t).length*3 + ss.filter(w=>w===t).length*1; }
      if(site && (it.source||"").includes(site)) s+=5;
      return s;
    }
    function runSearch(q){
      LAST_QUERY = (q||'').trim();
      const { site, tokens } = parseQuery(LAST_QUERY);
      let filtered = LATEST
        .map(it=>({it,s:scoreItem(it,tokens,site)}))
        .filter(x=>x.s>0)
        .sort((a,b)=>b.s-a.s)
        .map(x=>x.it);
      if(site) filtered = filtered.filter(it => (it.source||"").includes(site));
      renderList(filtered, elSearchResults, true);
      if (elSearchCount) elSearchCount.textContent = `${filtered.length}件`;
      // レコメンドは「過去傾向ベース」のまま（最新10件とは別枠）
    }

    // ===== レコメンド：お気に入り嗜好ベクトル × 履歴コーパス =====
    function renderRecommendations(){
      const favs = loadFavs();
      const favEmbs = favs.map(f => f.emb).filter(Boolean);
      let recs = [];

      if (favEmbs.length && CORPUS.length){
        const pref = meanVector(favEmbs);
        // コーパス全体から類似度Top（最新10件は別枠なので除外してもしなくてもOK）
        const latestUrls = new Set(LATEST.map(x=>x.url));
        const cand = CORPUS.filter(it => Array.isArray(it.emb) && !latestUrls.has(it.url));
        recs = cand.map(it => ({ it, s: cosineSim(pref, it.emb) }))
                   .sort((a,b)=> b.s - a.s)
                   .slice(0,5)   // 推薦は5件
                   .map(x=>x.it);
      }
      // お気に入りがまだ無い時は、コーパスの新着を表示
      if (recs.length===0){
        recs = CORPUS.slice().sort((a,b)=> String(b.published||"") > String(a.published||"") ? 1 : -1).slice(0,5);
      }
      renderList(recs, elRecoResults, false);
    }

    // ===== お気に入り（クリックでURLを展開） =====
    function renderFavorites(){
      const favs = loadFavs();
      if (!favs.length){
        elFavList.innerHTML = `<div class="muted">まだお気に入りがありません。</div>`;
        return;
      }
      elFavList.innerHTML = favs.map(f => {
        const title = esc(f.title || f.url);
        const url   = esc(f.url);
        const h     = esc(f.host || "");
        return `
          <details>
            <summary>${title} <span class="muted">(${h})</span></summary>
            <div class="fav-actions">
              <a class="btn" href="${url}" target="_blank" rel="noopener">原文を開く</a>
              <button class="btn" data-fav-del="${url}">お気に入りから削除</button>
            </div>
          </details>`;
      }).join("");

      // 削除ボタン
      elFavList.querySelectorAll('button[data-fav-del]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const u = e.currentTarget.getAttribute('data-fav-del');
          removeFavorite(u);
          renderFavInfo();
          renderFavorites();
          renderRecommendations(); // 嗜好が変わるため再計算
        });
      });
    }

    // ===== 描画共通 =====
    function cardHTML(it, withFavBtn){
      return `<article class="card">
        <div class="meta"><span class="chip">${esc(it.source||"source")}</span><span>${esc(it.published||"")}</span></div>
        <div class="title">${esc(it.title||"(無題)")}</div>
        <div class="summary">${esc(it.summary||"")}</div>
        <div class="actions">
          <a class="btn" href="${it.url}" target="_blank" rel="noopener">原文を開く</a>
          <button class="btn" data-copy="${esc((it.summary||"").replace(/"/g,'&quot;'))}">要約をコピー</button>
          ${withFavBtn ? `<button class="btn" data-fav="${esc(it.url)}">♡ お気に入り</button>` : ``}
        </div>
      </article>`;
    }
    function renderList(items, root, withFavBtn){
      if(!root) return;
      root.innerHTML = items && items.length ? items.map(it=>cardHTML(it, withFavBtn)).join("") : `<div class="muted">該当なし</div>`;
      root.querySelectorAll('button[data-copy]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          navigator.clipboard.writeText(e.currentTarget.dataset.copy||"");
          btn.textContent="コピーしました ✓"; setTimeout(()=>btn.textContent="要約をコピー",1200);
        });
      });
      if (withFavBtn){
        root.querySelectorAll('button[data-fav]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const url = e.currentTarget.getAttribute('data-fav');
            const item = LATEST.find(x => x.url === url) || CORPUS.find(x=>x.url===url);
            if (item){
              addFavorite(item);
              e.currentTarget.textContent = "★ 追加済み";
              setTimeout(()=> e.currentTarget.textContent = "♡ お気に入り", 1200);
              renderRecommendations();
              renderFavorites();
            }
          });
        });
      }
    }

    // ===== 外部URLを嗜好に追加（同ドメイン代表ベクトルを流用） =====
    function addExternalPreference(url){
      if(!url) return false;
      let u=url.trim(); if(!/^https?:\/\//.test(u)) u="https://"+u;
      const h = host(u);
      const sameHost = CORPUS.filter(it => (it.source||"") === h && Array.isArray(it.emb));
      if (sameHost.length){
        const d = sameHost[0].emb.length;
        const hostVec = meanVector(sameHost.map(it=>it.emb));
        const favs = loadFavs(); favs.push({ url:u, title:`(external) ${h}`, host:h, emb:hostVec });
        saveFavs(favs);
        renderRecommendations();
        renderFavorites();
        return true;
      } else {
        alert("同じドメインの記事がコーパスに無いので、この方法では嗜好に追加できません。まずはそのサイトをフィードに追加してください。");
        return false;
      }
    }

    // ===== イベント & 起動 =====
    window.addEventListener('DOMContentLoaded', () => {
      initRefs();
      $('#searchBtn').addEventListener('click', ()=> runSearch($('#searchInput').value));
      $('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(e.target.value); });
      $('#addPrefBtn').addEventListener('click', ()=>{
        const u = prompt('嗜好に反映したい外部リンクのURLを入力してください');
        if(u) addExternalPreference(u);
      });
      $('#clearFavBtn').addEventListener('click', ()=>{ if(confirm('お気に入りを全て削除しますか？')) clearFavorites(); });
      loadAll();
    });
  })();
  </script>

  <!-- Dify チャットボット（右下固定） -->
  <script> window.difyChatbotConfig = { token: 'G4x8fpppi7CUJMgV' } </script>
  <script src="https://udify.app/embed.min.js" id="G4x8fpppi7CUJMgV" defer></script>
  <style>
    #dify-chatbot-bubble-button { background-color:#1C64F2 !important; position:fixed !important; right:24px !important; bottom:24px !important; z-index:2147483647 !important; }
    #dify-chatbot-bubble-window { width:24rem !important; height:40rem !important; position:fixed !important; right:24px !important; bottom:92px !important; z-index:2147483647 !important; }
  </style>
</body>
</html>
